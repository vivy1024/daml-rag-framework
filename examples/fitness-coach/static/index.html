<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥èº«æ•™ç»ƒåŠ©æ‰‹ - DAML-RAG Framework</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Noto Sans SC', sans-serif;
        }

        .chat-container {
            height: calc(100vh - 200px);
        }

        .message-bubble {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .typing-indicator {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .health-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .health-healthy { background-color: #10b981; }
        .health-degraded { background-color: #f59e0b; }
        .health-unhealthy { background-color: #ef4444; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- å¤´éƒ¨å¯¼èˆª -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center">
                    <i class="fas fa-dumbbell text-blue-600 text-2xl mr-3"></i>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">å¥èº«æ•™ç»ƒåŠ©æ‰‹</h1>
                        <p class="text-xs text-gray-500">åŸºäº DAML-RAG Framework</p>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <div class="flex items-center text-sm text-gray-600">
                        <span>ç³»ç»ŸçŠ¶æ€:</span>
                        <span id="health-status" class="health-indicator health-healthy ml-2"></span>
                        <span id="health-text" class="ml-1">å¥åº·</span>
                    </div>
                    <button id="clear-chat" class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-md transition-colors">
                        <i class="fas fa-trash mr-1"></i>æ¸…ç©ºå¯¹è¯
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- ä¾§è¾¹æ  -->
            <div class="lg:col-span-1">
                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="bg-white rounded-lg shadow p-4 mb-4">
                    <h3 class="font-semibold text-gray-900 mb-3">
                        <i class="fas fa-chart-line mr-2"></i>ç³»ç»Ÿç»Ÿè®¡
                    </h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">æ€»æŸ¥è¯¢æ•°:</span>
                            <span id="total-queries" class="font-medium">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">å¹³å‡å“åº”æ—¶é—´:</span>
                            <span id="avg-response-time" class="font-medium">0ms</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">æ´»è·ƒä¼šè¯:</span>
                            <span id="active-sessions" class="font-medium">1</span>
                        </div>
                    </div>
                </div>

                <!-- å¿«æ·é—®é¢˜ -->
                <div class="bg-white rounded-lg shadow p-4">
                    <h3 class="font-semibold text-gray-900 mb-3">
                        <i class="fas fa-lightbulb mr-2"></i>å¿«æ·é—®é¢˜
                    </h3>
                    <div class="space-y-2">
                        <button class="quick-question w-full text-left px-3 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-md transition-colors text-sm"
                                data-question="æˆ‘æƒ³åˆ¶å®šä¸€ä¸ªå¢è‚Œè®¡åˆ’">
                            ğŸ’ª åˆ¶å®šå¢è‚Œè®¡åˆ’
                        </button>
                        <button class="quick-question w-full text-left px-3 py-2 bg-green-50 hover:bg-green-100 text-green-700 rounded-md transition-colors text-sm"
                                data-question="æ·±è¹²çš„æ­£ç¡®åŠ¨ä½œè¦é¢†æ˜¯ä»€ä¹ˆï¼Ÿ">
                            ğŸ‹ï¸ æ·±è¹²åŠ¨ä½œæŒ‡å¯¼
                        </button>
                        <button class="quick-question w-full text-left px-3 py-2 bg-yellow-50 hover:bg-yellow-100 text-yellow-700 rounded-md transition-colors text-sm"
                                data-question="è†ç›–æœ‰æ—§ä¼¤ï¼Œå¦‚ä½•å®‰å…¨è®­ç»ƒè…¿éƒ¨ï¼Ÿ">
                            ğŸ¥ æŸä¼¤åº·å¤å’¨è¯¢
                        </button>
                        <button class="quick-question w-full text-left px-3 py-2 bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-md transition-colors text-sm"
                                data-question="å¢è‚ŒæœŸé—´åº”è¯¥å¦‚ä½•å®‰æ’é¥®é£Ÿï¼Ÿ">
                            ğŸ¥— è¥å…»é¥®é£Ÿå»ºè®®
                        </button>
                    </div>
                </div>

                <!-- åŠŸèƒ½ä»‹ç» -->
                <div class="bg-white rounded-lg shadow p-4 mt-4">
                    <h3 class="font-semibold text-gray-900 mb-3">
                        <i class="fas fa-info-circle mr-2"></i>åŠŸèƒ½ç‰¹æ€§
                    </h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>â€¢ æ™ºèƒ½å¯¹è¯äº¤äº’</li>
                        <li>â€¢ ä¸ªæ€§åŒ–è®­ç»ƒè®¡åˆ’</li>
                        <li>â€¢ è¿åŠ¨æŸä¼¤åº·å¤æŒ‡å¯¼</li>
                        <li>â€¢ è¥å…»é¥®é£Ÿå»ºè®®</li>
                        <li>â€¢ å®æ—¶æ€§èƒ½ç›‘æ§</li>
                    </ul>
                </div>
            </div>

            <!-- èŠå¤©åŒºåŸŸ -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-lg shadow h-full flex flex-col">
                    <!-- èŠå¤©å¤´éƒ¨ -->
                    <div class="border-b px-4 py-3">
                        <div class="flex items-center justify-between">
                            <h2 class="font-semibold text-gray-900">
                                <i class="fas fa-comments mr-2"></i>æ™ºèƒ½å¯¹è¯
                            </h2>
                            <div class="text-sm text-gray-500">
                                <span id="session-id">ä¼šè¯: è¿æ¥ä¸­...</span>
                            </div>
                        </div>
                    </div>

                    <!-- æ¶ˆæ¯åŒºåŸŸ -->
                    <div id="chat-messages" class="chat-container flex-1 overflow-y-auto p-4 space-y-4">
                        <!-- æ¬¢è¿æ¶ˆæ¯ -->
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                                <i class="fas fa-robot text-white text-sm"></i>
                            </div>
                            <div class="ml-3 max-w-md">
                                <div class="bg-blue-50 rounded-lg p-3 message-bubble">
                                    <p class="text-sm text-blue-900">
                                        ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„å¥èº«æ•™ç»ƒåŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®åŠ©ä½ ï¼š
                                    </p>
                                    <ul class="text-sm text-blue-800 mt-2 space-y-1">
                                        <li>åˆ¶å®šä¸ªæ€§åŒ–è®­ç»ƒè®¡åˆ’</li>
                                        <li>æä¾›åŠ¨ä½œæŒ‡å¯¼å’ŒæŠ€å·§</li>
                                        <li>è¿åŠ¨æŸä¼¤åº·å¤å»ºè®®</li>
                                        <li>è¥å…»å’Œé¥®é£ŸæŒ‡å¯¼</li>
                                    </ul>
                                    <p class="text-sm text-blue-900 mt-2">
                                        è¯·å‘Šè¯‰æˆ‘ä½ çš„å¥èº«ç›®æ ‡æˆ–é—®é¢˜å§ï¼
                                    </p>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">AIå¥èº«æ•™ç»ƒ</p>
                            </div>
                        </div>
                    </div>

                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div class="border-t p-4">
                        <div class="flex space-x-2">
                            <input
                                type="text"
                                id="message-input"
                                placeholder="è¾“å…¥ä½ çš„å¥èº«é—®é¢˜..."
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                maxlength="500"
                            >
                            <button
                                id="send-button"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                            >
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div class="mt-2 flex justify-between items-center text-xs text-gray-500">
                            <span id="char-count">0 / 500</span>
                            <span id="model-info" class="hidden">
                                <i class="fas fa-microchip mr-1"></i>
                                <span id="model-name">å‡†å¤‡å°±ç»ª</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- é¡µè„š -->
    <footer class="bg-gray-800 text-white py-4 mt-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center">
                <div class="text-sm">
                    <p>Â© 2025 å¥èº«æ•™ç»ƒåŠ©æ‰‹ - åŸºäº DAML-RAG Framework</p>
                </div>
                <div class="text-sm">
                    <span>æŠ€æœ¯æ”¯æŒ: </span>
                    <a href="https://github.com/daml-rag/daml-rag-framework" class="text-blue-400 hover:text-blue-300" target="_blank">
                        GitHub
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        class FitnessCoachApp {
            constructor() {
                this.sessionId = null;
                this.isConnected = false;
                this.ws = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.connectWebSocket();
                this.loadStats();
            }

            setupEventListeners() {
                // å‘é€æŒ‰é’®
                document.getElementById('send-button').addEventListener('click', () => {
                    this.sendMessage();
                });

                // è¾“å…¥æ¡†
                const input = document.getElementById('message-input');
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });

                // å­—ç¬¦è®¡æ•°
                input.addEventListener('input', (e) => {
                    const length = e.target.value.length;
                    document.getElementById('char-count').textContent = `${length} / 500`;

                    const sendBtn = document.getElementById('send-button');
                    sendBtn.disabled = length === 0 || !this.isConnected;
                });

                // å¿«æ·é—®é¢˜
                document.querySelectorAll('.quick-question').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const question = e.target.dataset.question;
                        document.getElementById('message-input').value = question;
                        document.getElementById('char-count').textContent = `${question.length} / 500`;
                        this.sendMessage();
                    });
                });

                // æ¸…ç©ºå¯¹è¯
                document.getElementById('clear-chat').addEventListener('click', () => {
                    this.clearChat();
                });
            }

            async connectWebSocket() {
                try {
                    // å…ˆåˆ›å»ºä¼šè¯
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: 'ä½ å¥½ï¼Œè¯·å¼€å§‹æˆ‘ä»¬çš„å¯¹è¯',
                            user_id: 'web_user'
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.sessionId = data.session_id;
                        this.isConnected = true;

                        document.getElementById('session-id').textContent = `ä¼šè¯: ${this.sessionId.slice(-8)}`;
                        document.getElementById('send-button').disabled = false;

                        this.addMessage('user', 'ä½ å¥½ï¼Œè¯·å¼€å§‹æˆ‘ä»¬çš„å¯¹è¯');
                        this.addMessage('assistant', data.response, data.sources, data.model_used, data.execution_time);

                        // æ˜¾ç¤ºæ¨¡å‹ä¿¡æ¯
                        this.showModelInfo(data.model_used);
                    } else {
                        throw new Error('åˆ›å»ºä¼šè¯å¤±è´¥');
                    }
                } catch (error) {
                    console.error('è¿æ¥å¤±è´¥:', error);
                    this.addMessage('system', 'è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
            }

            async sendMessage() {
                const input = document.getElementById('message-input');
                const message = input.value.trim();

                if (!message || !this.isConnected) return;

                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                this.addMessage('user', message);

                // æ¸…ç©ºè¾“å…¥æ¡†
                input.value = '';
                document.getElementById('char-count').textContent = '0 / 500';
                document.getElementById('send-button').disabled = true;

                try {
                    // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥
                    this.showTypingIndicator();

                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            user_id: 'web_user',
                            session_id: this.sessionId
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.hideTypingIndicator();
                        this.addMessage('assistant', data.response, data.sources, data.model_used, data.execution_time);
                        this.showModelInfo(data.model_used);
                        this.updateStats();
                    } else {
                        throw new Error('å‘é€æ¶ˆæ¯å¤±è´¥');
                    }
                } catch (error) {
                    console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                    this.hideTypingIndicator();
                    this.addMessage('system', 'å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œè¯·é‡è¯•');
                } finally {
                    document.getElementById('send-button').disabled = false;
                }
            }

            addMessage(type, content, sources = [], model = '', executionTime = 0) {
                const messagesContainer = document.getElementById('chat-messages');

                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start message-bubble';

                if (type === 'user') {
                    messageDiv.innerHTML = `
                        <div class="ml-3 max-w-md">
                            <div class="bg-gray-100 rounded-lg p-3">
                                <p class="text-sm text-gray-900">${this.escapeHtml(content)}</p>
                            </div>
                            <p class="text-xs text-gray-500 mt-1 text-right">ä½ </p>
                        </div>
                        <div class="flex-shrink-0 w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center ml-3">
                            <i class="fas fa-user text-white text-sm"></i>
                        </div>
                    `;
                } else if (type === 'assistant') {
                    let sourceHtml = '';
                    if (sources && sources.length > 0) {
                        sourceHtml = `
                            <div class="mt-2 p-2 bg-blue-100 rounded text-xs">
                                <span class="font-medium text-blue-800">ä¿¡æ¯æ¥æº:</span>
                                <span class="text-blue-600">${sources.length} ä¸ªç›¸å…³çŸ¥è¯†</span>
                            </div>
                        `;
                    }

                    let metaHtml = '';
                    if (model || executionTime > 0) {
                        metaHtml = `
                            <div class="flex items-center space-x-2 text-xs text-gray-500 mt-1">
                                ${model ? `<span><i class="fas fa-microchip mr-1"></i>${model}</span>` : ''}
                                ${executionTime > 0 ? `<span><i class="fas fa-clock mr-1"></i>${executionTime.toFixed(2)}s</span>` : ''}
                            </div>
                        `;
                    }

                    messageDiv.innerHTML = `
                        <div class="flex-shrink-0 w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="ml-3 max-w-md">
                            <div class="bg-blue-50 rounded-lg p-3">
                                <p class="text-sm text-blue-900">${this.escapeHtml(content)}</p>
                                ${sourceHtml}
                            </div>
                            ${metaHtml}
                            <p class="text-xs text-gray-500 mt-1">AIå¥èº«æ•™ç»ƒ</p>
                        </div>
                    `;
                } else if (type === 'system') {
                    messageDiv.innerHTML = `
                        <div class="w-full">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-center">
                                <p class="text-sm text-yellow-800">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>
                                    ${this.escapeHtml(content)}
                                </p>
                            </div>
                        </div>
                    `;
                }

                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            showTypingIndicator() {
                const messagesContainer = document.getElementById('chat-messages');
                const indicatorDiv = document.createElement('div');
                indicatorDiv.id = 'typing-indicator';
                indicatorDiv.className = 'flex items-start message-bubble';
                indicatorDiv.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="ml-3">
                        <div class="bg-blue-50 rounded-lg p-3">
                            <div class="typing-indicator flex space-x-1">
                                <div class="w-2 h-2 bg-blue-400 rounded-full"></div>
                                <div class="w-2 h-2 bg-blue-400 rounded-full"></div>
                                <div class="w-2 h-2 bg-blue-400 rounded-full"></div>
                            </div>
                        </div>
                    </div>
                `;
                messagesContainer.appendChild(indicatorDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            hideTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }

            showModelInfo(model) {
                const modelInfo = document.getElementById('model-info');
                const modelName = document.getElementById('model-name');

                modelInfo.classList.remove('hidden');
                modelName.textContent = model || 'æœªçŸ¥æ¨¡å‹';

                // 3ç§’åéšè—
                setTimeout(() => {
                    modelInfo.classList.add('hidden');
                }, 3000);
            }

            clearChat() {
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0 w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="ml-3 max-w-md">
                            <div class="bg-blue-50 rounded-lg p-3 message-bubble">
                                <p class="text-sm text-blue-900">å¯¹è¯å·²æ¸…ç©ºï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ</p>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">AIå¥èº«æ•™ç»ƒ</p>
                        </div>
                    </div>
                `;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            async loadStats() {
                try {
                    const response = await fetch('/api/stats');
                    if (response.ok) {
                        const stats = await response.json();
                        this.updateStatsDisplay(stats);
                    }
                } catch (error) {
                    console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
                }
            }

            updateStatsDisplay(stats) {
                if (stats.framework && stats.framework.query_stats) {
                    document.getElementById('total-queries').textContent =
                        stats.framework.query_stats.total_queries;
                    document.getElementById('avg-response-time').textContent =
                        (stats.framework.query_stats.average_response_time * 1000).toFixed(0) + 'ms';
                }
                if (stats.sessions) {
                    document.getElementById('active-sessions').textContent =
                        stats.sessions.active;
                }
            }

            async updateStats() {
                await this.loadStats();
            }

            async checkHealth() {
                try {
                    const response = await fetch('/api/health');
                    if (response.ok) {
                        const health = await response.json();
                        this.updateHealthIndicator(health);
                    }
                } catch (error) {
                    console.error('å¥åº·æ£€æŸ¥å¤±è´¥:', error);
                }
            }

            updateHealthIndicator(health) {
                const indicator = document.getElementById('health-status');
                const text = document.getElementById('health-text');

                indicator.className = 'health-indicator';

                if (health.status === 'healthy') {
                    indicator.classList.add('health-healthy');
                    text.textContent = 'å¥åº·';
                } else if (health.status === 'degraded') {
                    indicator.classList.add('health-degraded');
                    text.textContent = 'é™çº§';
                } else {
                    indicator.classList.add('health-unhealthy');
                    text.textContent = 'å¼‚å¸¸';
                }
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            new FitnessCoachApp();

            // å®šæœŸæ£€æŸ¥å¥åº·çŠ¶æ€
            setInterval(() => {
                const app = new FitnessCoachApp();
                app.checkHealth();
            }, 30000);
        });
    </script>
</body>
</html>