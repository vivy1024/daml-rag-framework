# MCPç¼–æ’æ¶æ„

**ç‰ˆæœ¬**: v1.0.0  
**æ›´æ–°æ—¥æœŸ**: 2025-11-06  
**çŠ¶æ€**: ğŸ¯ é€šç”¨æ¶æ„è§„èŒƒ

---

## ğŸ“‹ æ–‡æ¡£ç›®çš„

æœ¬æ–‡æ¡£å®šä¹‰äº† DAML-RAG æ¡†æ¶ä¸­**MCPå·¥å…·ç¼–æ’å™¨çš„é€šç”¨æ¶æ„**ã€‚å®ƒæ˜¯**é¢†åŸŸæ— å…³çš„**ï¼Œå¯ä»¥é€‚é…åˆ°ä»»ä½•ä½¿ç”¨MCPå·¥å…·çš„AIåº”ç”¨ã€‚

---

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

### ä¸ºä»€ä¹ˆéœ€è¦ç¼–æ’å™¨ï¼Ÿ

åœ¨å¤šå·¥å…·AIç³»ç»Ÿä¸­ï¼Œå•ä¸ªæŸ¥è¯¢å¯èƒ½éœ€è¦è°ƒç”¨å¤šä¸ªMCPå·¥å…·ï¼š

```
ç”¨æˆ·æŸ¥è¯¢ï¼š"åˆ¶å®šä¸ªæ€§åŒ–æ–¹æ¡ˆ"
    â†“
éœ€è¦è°ƒç”¨çš„å·¥å…·ï¼š
  1. get_user_profileï¼ˆè·å–ç”¨æˆ·ä¿¡æ¯ï¼‰
  2. search_knowledgeï¼ˆæœç´¢çŸ¥è¯†åº“ï¼‰
  3. generate_planï¼ˆç”Ÿæˆæ–¹æ¡ˆï¼‰
```

**æŒ‘æˆ˜**ï¼š
- âŒ **ä¾èµ–å…³ç³»**ï¼šå·¥å…·2ä¾èµ–å·¥å…·1çš„ç»“æœ
- âŒ **æ‰§è¡Œé¡ºåº**ï¼šå¿…é¡»å…ˆæ‰§è¡Œå·¥å…·1ï¼Œå†æ‰§è¡Œå·¥å…·2
- âŒ **å¹¶è¡Œæœºä¼š**ï¼šå¦‚æœå·¥å…·2å’Œå·¥å…·3æ— ä¾èµ–ï¼Œå¯ä»¥å¹¶è¡Œæ‰§è¡Œ
- âŒ **é”™è¯¯å¤„ç†**ï¼šæŸä¸ªå·¥å…·å¤±è´¥åå¦‚ä½•å¤„ç†ï¼Ÿ

**ç¼–æ’å™¨çš„ä½œç”¨**ï¼š
- âœ… è‡ªåŠ¨è¯†åˆ«å·¥å…·ä¾èµ–å…³ç³»
- âœ… ç¡®å®šåˆæ³•çš„æ‰§è¡Œé¡ºåº
- âœ… æœ€å¤§åŒ–å¹¶è¡Œæ‰§è¡Œ
- âœ… æä¾›å®¹é”™æœºåˆ¶

---

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„

### 1. ä»»åŠ¡DAGï¼ˆæœ‰å‘æ— ç¯å›¾ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ä»»åŠ¡ä¾èµ–å…³ç³»ï¼ˆDAGï¼‰                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚       Task1: get_context                            â”‚
â”‚         â†“                                           â”‚
â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                                      â”‚
â”‚    â†“         â†“                                      â”‚
â”‚  Task2     Task3                                    â”‚
â”‚  search    analyze                                  â”‚
â”‚    â†“         â†“                                      â”‚
â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                      â”‚
â”‚         â†“                                           â”‚
â”‚      Task4: generate                                â”‚
â”‚                                                     â”‚
â”‚  æ‰§è¡Œé¡ºåºï¼š                                           â”‚
â”‚  1. Task1 å…ˆæ‰§è¡Œï¼ˆæ— ä¾èµ–ï¼‰                            â”‚
â”‚  2. Task2 å’Œ Task3 å¹¶è¡Œæ‰§è¡Œï¼ˆéƒ½ä¾èµ–Task1ï¼‰             â”‚
â”‚  3. Task4 æœ€åæ‰§è¡Œï¼ˆä¾èµ–Task2å’ŒTask3ï¼‰                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®ç»“æ„**ï¼š
```python
@dataclass
class Task:
    task_id: str           # ä»»åŠ¡å”¯ä¸€æ ‡è¯†
    tool_name: str         # MCPå·¥å…·åç§°
    params: Dict[str, Any] # å·¥å…·å‚æ•°
    depends_on: List[str]  # ä¾èµ–çš„ä»»åŠ¡IDåˆ—è¡¨
```

---

### 2. Kahnæ‹“æ‰‘æ’åºç®—æ³•

**ç†è®ºåŸºç¡€**ï¼š
- è®ºæ–‡ï¼šKahn's Algorithm (1962)
- æ—¶é—´å¤æ‚åº¦ï¼šO(V + E)ï¼ŒV=èŠ‚ç‚¹æ•°ï¼ŒE=è¾¹æ•°

**ç®—æ³•æ­¥éª¤**ï¼š

```python
def topological_sort(tasks):
    """
    Kahnæ‹“æ‰‘æ’åº
    
    è¾“å…¥ï¼šä»»åŠ¡åˆ—è¡¨ï¼ˆå¸¦ä¾èµ–å…³ç³»ï¼‰
    è¾“å‡ºï¼šåˆæ³•çš„æ‰§è¡Œé¡ºåº
    """
    # 1. è®¡ç®—å…¥åº¦ï¼ˆæ¯ä¸ªä»»åŠ¡è¢«å¤šå°‘ä¸ªä»»åŠ¡ä¾èµ–ï¼‰
    in_degree = {}
    for task in tasks:
        in_degree[task.task_id] = len(task.depends_on)
    
    # 2. æ‰¾åˆ°æ‰€æœ‰å…¥åº¦ä¸º0çš„ä»»åŠ¡ï¼ˆå¯ä»¥ç«‹å³æ‰§è¡Œï¼‰
    queue = [task for task in tasks if in_degree[task.task_id] == 0]
    execution_order = []
    
    # 3. æ‹“æ‰‘æ’åº
    while queue:
        # å–å‡ºä¸€ä¸ªå…¥åº¦ä¸º0çš„ä»»åŠ¡
        current = queue.pop(0)
        execution_order.append(current)
        
        # å‡å°‘å…¶åç»§ä»»åŠ¡çš„å…¥åº¦
        for task in tasks:
            if current.task_id in task.depends_on:
                in_degree[task.task_id] -= 1
                # å¦‚æœå…¥åº¦å˜ä¸º0ï¼ŒåŠ å…¥é˜Ÿåˆ—
                if in_degree[task.task_id] == 0:
                    queue.append(task)
    
    # 4. æ£€æµ‹å¾ªç¯ä¾èµ–
    if len(execution_order) != len(tasks):
        raise CyclicDependencyError("æ£€æµ‹åˆ°å¾ªç¯ä¾èµ–")
    
    return execution_order
```

**ç¤ºä¾‹**ï¼š
```python
tasks = [
    Task("task1", "tool1", {}, depends_on=[]),
    Task("task2", "tool2", {}, depends_on=["task1"]),
    Task("task3", "tool3", {}, depends_on=["task1"]),
    Task("task4", "tool4", {}, depends_on=["task2", "task3"])
]

# æ‹“æ‰‘æ’åºç»“æœï¼š
# [task1, task2, task3, task4] æˆ– [task1, task3, task2, task4]
# ï¼ˆtask2å’Œtask3é¡ºåºå¯ä»¥äº¤æ¢ï¼Œå› ä¸ºå®ƒä»¬æ— ä¾èµ–ï¼‰
```

---

### 3. å¼‚æ­¥å¹¶è¡Œæ‰§è¡Œ

**ç†è®ºåŸºç¡€**ï¼š
- Python asyncioï¼šå¼‚æ­¥I/Oæ¡†æ¶
- asyncio.gatherï¼šå¹¶è¡Œæ‰§è¡Œå¤šä¸ªåç¨‹

**å¹¶è¡Œç­–ç•¥**ï¼š
```python
async def execute_parallel(tasks):
    """
    å¹¶è¡Œæ‰§è¡Œæ— ä¾èµ–çš„ä»»åŠ¡
    """
    # 1. æŒ‰æ‰§è¡Œå±‚çº§åˆ†ç»„
    levels = group_by_level(tasks)
    
    # levels = {
    #   0: [task1],           # ç¬¬0å±‚ï¼šæ— ä¾èµ–
    #   1: [task2, task3],    # ç¬¬1å±‚ï¼šä¾èµ–ç¬¬0å±‚
    #   2: [task4]            # ç¬¬2å±‚ï¼šä¾èµ–ç¬¬1å±‚
    # }
    
    results = {}
    
    # 2. é€å±‚æ‰§è¡Œ
    for level in sorted(levels.keys()):
        level_tasks = levels[level]
        
        # 3. åŒå±‚ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œ
        level_results = await asyncio.gather(
            *[execute_task(task, results) for task in level_tasks],
            return_exceptions=True  # å®¹é”™ï¼šå•ä¸ªä»»åŠ¡å¤±è´¥ä¸å½±å“å…¶ä»–ä»»åŠ¡
        )
        
        # 4. æ”¶é›†ç»“æœ
        for task, result in zip(level_tasks, level_results):
            if isinstance(result, Exception):
                results[task.task_id] = {"error": str(result)}
            else:
                results[task.task_id] = result
    
    return results
```

**å¹¶è¡Œæ•ˆæœç¤ºä¾‹**ï¼š
```
ä¸²è¡Œæ‰§è¡Œï¼štask1(1s) â†’ task2(2s) â†’ task3(2s) â†’ task4(1s) = 6ç§’
å¹¶è¡Œæ‰§è¡Œï¼štask1(1s) â†’ [task2(2s) || task3(2s)] â†’ task4(1s) = 4ç§’
             â†‘             â†‘ å¹¶è¡Œæ‰§è¡Œ â†‘
         èŠ‚çœ2ç§’
```

---

### 4. ä¾èµ–å›¾å®šä¹‰

**é¢†åŸŸé€‚é…å™¨éœ€è¦å®šä¹‰**ï¼š

```python
# ç¤ºä¾‹ï¼šå¥èº«é¢†åŸŸçš„å·¥å…·ä¾èµ–å›¾
DEPENDENCY_GRAPH = {
    # åŸºç¡€å·¥å…·ï¼ˆæ— ä¾èµ–ï¼‰
    "get_user_profile": [],
    "search_knowledge": [],
    
    # é«˜çº§å·¥å…·ï¼ˆä¾èµ–åŸºç¡€å·¥å…·ï¼‰
    "generate_plan": ["get_user_profile", "search_knowledge"],
    "evaluate_progress": ["get_user_profile"],
    
    # ç»¼åˆå·¥å…·ï¼ˆä¾èµ–å¤šä¸ªå·¥å…·ï¼‰
    "create_personalized_program": [
        "get_user_profile",
        "search_knowledge",
        "generate_plan"
    ]
}
```

**ä¾èµ–å›¾è§„åˆ™**ï¼š
1. **ç¦æ­¢å¾ªç¯ä¾èµ–**ï¼šAä¾èµ–Bï¼ŒBä¸èƒ½ä¾èµ–A
2. **ä¼ é€’æ€§è‡ªåŠ¨å¤„ç†**ï¼šAä¾èµ–Bï¼ŒBä¾èµ–Cï¼Œç¼–æ’å™¨è‡ªåŠ¨æ¨å¯¼Aâ†’C
3. **å¯é€‰ä¾èµ–**ï¼šæŸäº›ä¾èµ–å¯ä»¥æ ‡è®°ä¸ºå¯é€‰ï¼ˆå¤±è´¥ä¸å½±å“æ‰§è¡Œï¼‰

---

## ğŸ”§ é«˜çº§ç‰¹æ€§

### 5.1 TTLç¼“å­˜æœºåˆ¶

**é—®é¢˜**ï¼šçŸ­æ—¶é—´å†…é‡å¤è°ƒç”¨åŒä¸€å·¥å…·æµªè´¹èµ„æº

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
class TaskCache:
    """
    TTLï¼ˆTime-To-Liveï¼‰ç¼“å­˜
    """
    def __init__(self, ttl_seconds=300):
        self.cache = {}
        self.ttl = ttl_seconds
    
    def get(self, task_id, params):
        """è·å–ç¼“å­˜ç»“æœ"""
        cache_key = self._make_key(task_id, params)
        
        if cache_key in self.cache:
            result, timestamp = self.cache[cache_key]
            
            # æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
            if time.time() - timestamp < self.ttl:
                return result
            else:
                # è¿‡æœŸï¼Œåˆ é™¤ç¼“å­˜
                del self.cache[cache_key]
        
        return None
    
    def set(self, task_id, params, result):
        """è®¾ç½®ç¼“å­˜"""
        cache_key = self._make_key(task_id, params)
        self.cache[cache_key] = (result, time.time())
```

**ç¼“å­˜ç­–ç•¥**ï¼š
- é»˜è®¤TTLï¼š300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰
- ç¼“å­˜é”®ï¼š`task_id + hash(params)`
- è‡ªåŠ¨è¿‡æœŸæ¸…ç†

---

### 5.2 é”™è¯¯å¤„ç†ä¸å®¹é”™

**å¤±è´¥éš”ç¦»**ï¼š
```python
async def execute_with_error_handling(task):
    """
    å•ä¸ªä»»åŠ¡å¤±è´¥ä¸å½±å“å…¶ä»–ä»»åŠ¡
    """
    try:
        result = await mcp_client.call_tool(task.tool_name, task.params)
        return {"status": "success", "data": result}
    
    except Exception as e:
        logger.error(f"Task {task.task_id} failed: {e}")
        return {"status": "failed", "error": str(e)}
```

**é™çº§ç­–ç•¥**ï¼š
```python
# æ ‡è®°æŸäº›ä»»åŠ¡ä¸º"å¯é€‰"
Task("optional_task", "tool", {}, 
     depends_on=["required_task"],
     optional=True)  # å¤±è´¥ä¸å½±å“åç»­ä»»åŠ¡

# æ‰§è¡Œæ—¶æ£€æŸ¥
if task.optional and task.status == "failed":
    logger.warning(f"Optional task {task.task_id} failed, continuing...")
    continue
```

---

### 5.3 å¾ªç¯ä¾èµ–æ£€æµ‹

**ç®—æ³•**ï¼šæ·±åº¦ä¼˜å…ˆæœç´¢ï¼ˆDFSï¼‰

```python
def detect_cycle(tasks):
    """
    æ£€æµ‹å¾ªç¯ä¾èµ–
    
    ç®—æ³•ï¼šDFS + ä¸‰è‰²æ ‡è®°
    - ç™½è‰²ï¼ˆ0ï¼‰ï¼šæœªè®¿é—®
    - ç°è‰²ï¼ˆ1ï¼‰ï¼šæ­£åœ¨è®¿é—®
    - é»‘è‰²ï¼ˆ2ï¼‰ï¼šå·²å®Œæˆè®¿é—®
    """
    colors = {task.task_id: 0 for task in tasks}
    
    def dfs(task_id):
        if colors[task_id] == 1:
            # æ­£åœ¨è®¿é—®ï¼Œå‘ç°ç¯
            return True
        
        if colors[task_id] == 2:
            # å·²è®¿é—®
            return False
        
        # æ ‡è®°ä¸ºæ­£åœ¨è®¿é—®
        colors[task_id] = 1
        
        # é€’å½’è®¿é—®ä¾èµ–
        task = next(t for t in tasks if t.task_id == task_id)
        for dep in task.depends_on:
            if dfs(dep):
                return True
        
        # æ ‡è®°ä¸ºå·²å®Œæˆ
        colors[task_id] = 2
        return False
    
    # æ£€æŸ¥æ‰€æœ‰ä»»åŠ¡
    for task in tasks:
        if colors[task.task_id] == 0:
            if dfs(task.task_id):
                raise CyclicDependencyError(
                    f"æ£€æµ‹åˆ°å¾ªç¯ä¾èµ–ï¼Œæ¶‰åŠä»»åŠ¡: {task.task_id}"
                )
```

---

## ğŸ“Š å®Œæ•´æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           MCPç¼–æ’å™¨æ‰§è¡Œæµç¨‹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  Step 1: æ„å›¾è¯†åˆ«ï¼ˆIntent Recognitionï¼‰              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç”¨æˆ·æŸ¥è¯¢ â†’ è¯†åˆ«éœ€è¦çš„å·¥å…·åˆ—è¡¨                    â”‚ â”‚
â”‚  â”‚ "åˆ¶å®šå¢è‚Œè®¡åˆ’" â†’ [get_profile, search, plan]  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â†“                                           â”‚
â”‚  Step 2: DAGæ„å»ºï¼ˆTask Decompositionï¼‰              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ ¹æ®ä¾èµ–å›¾ç”Ÿæˆä»»åŠ¡DAG                           â”‚ â”‚
â”‚  â”‚ Task1(get_profile) â†’ Task2(search) â†’ Task3   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â†“                                           â”‚
â”‚  Step 3: å¾ªç¯æ£€æµ‹ï¼ˆCycle Detectionï¼‰                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ DFSæ£€æµ‹å¾ªç¯ä¾èµ–                                â”‚ â”‚
â”‚  â”‚ å¦‚æœå­˜åœ¨å¾ªç¯ â†’ æŠ›å‡ºå¼‚å¸¸                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â†“                                           â”‚
â”‚  Step 4: æ‹“æ‰‘æ’åºï¼ˆTopological Sortï¼‰               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Kahnç®—æ³•ç¡®å®šæ‰§è¡Œé¡ºåº                            â”‚ â”‚
â”‚  â”‚ [Task1] â†’ [Task2, Task3] â†’ [Task4]           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â†“                                           â”‚
â”‚  Step 5: å¹¶è¡Œæ‰§è¡Œï¼ˆParallel Executionï¼‰             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ é€å±‚æ‰§è¡Œï¼ŒåŒå±‚å¹¶è¡Œ                              â”‚ â”‚
â”‚  â”‚ asyncio.gather([Task2, Task3])                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â†“                                           â”‚
â”‚  Step 6: ç»“æœèšåˆï¼ˆResult Aggregationï¼‰             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ”¶é›†æ‰€æœ‰å·¥å…·ç»“æœ                                â”‚ â”‚
â”‚  â”‚ {task1: {...}, task2: {...}, task3: {...}}   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ å¯é€‰ç‰¹æ€§

ä»¥ä¸‹ç‰¹æ€§å¯æ ¹æ®é¢†åŸŸéœ€æ±‚é€‰æ‹©æ€§å®æ–½ï¼š

### å¯é€‰1: æ™ºèƒ½é¢„åŠ è½½ï¼ˆé€‚ç”¨äºç”¨æˆ·æ¡£æ¡ˆåœºæ™¯ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- éœ€è¦é¢‘ç¹è®¿é—®ç”¨æˆ·æ¡£æ¡ˆçš„é¢†åŸŸï¼ˆå¦‚ä¸ªæ€§åŒ–æ¨èã€å®šåˆ¶åŒ–æœåŠ¡ï¼‰
- å¤šä¸ªå·¥å…·éƒ½éœ€è¦ç›¸åŒçš„ç”¨æˆ·ä¿¡æ¯

**å®ç°æ€è·¯**ï¼š
```python
# åœ¨ç¼–æ’å¼€å§‹å‰é¢„åŠ è½½ç”¨æˆ·æ•°æ®
preloaded_data = None
if context and 'user_id' in context:
    preloaded_data = await get_user_profile(context['user_id'])

# ç¼–æ’å™¨æ£€æµ‹åˆ°éœ€è¦user_profileçš„ä»»åŠ¡æ—¶ï¼Œç›´æ¥ä½¿ç”¨é¢„åŠ è½½æ•°æ®
if preloaded_data:
    # ç§»é™¤é‡å¤çš„get_user_profileä»»åŠ¡
    tasks = [t for t in tasks if t.tool_name != 'get_user_profile']
    # å°†é¢„åŠ è½½æ•°æ®æ³¨å…¥åˆ°ä¾èµ–å®ƒçš„ä»»åŠ¡ä¸­
    for task in tasks:
        if 'get_user_profile' in task.depends_on:
            task.params['preloaded_profile'] = preloaded_data
```

**è®¾è®¡ç›®æ ‡**ï¼š
- å‡å°‘é‡å¤MCPè°ƒç”¨
- é™ä½å“åº”å»¶è¿Ÿ
- ä¿æŒå¥å£®æ€§ï¼ˆé¢„åŠ è½½å¤±è´¥æ—¶é™çº§åˆ°æ ‡å‡†æµç¨‹ï¼‰

**æ³¨æ„**ï¼šæ­¤ç‰¹æ€§ä¸æ˜¯æ‰€æœ‰é¢†åŸŸéƒ½éœ€è¦ï¼Œä»…åœ¨ç”¨æˆ·æ¡£æ¡ˆè®¿é—®é¢‘ç¹æ—¶è€ƒè™‘ã€‚

---

### å¯é€‰2: åŠ¨æ€ä»»åŠ¡è°ƒæ•´

**é€‚ç”¨åœºæ™¯**ï¼š
- è¿è¡Œæ—¶æ ¹æ®ä¸­é—´ç»“æœåŠ¨æ€æ·»åŠ /åˆ é™¤ä»»åŠ¡
- éœ€è¦æ¡ä»¶åˆ†æ”¯çš„å¤æ‚å·¥ä½œæµ

**å®ç°æ€è·¯**ï¼š
```python
# æ ¹æ®ä¸­é—´ç»“æœåŠ¨æ€è°ƒæ•´ä»»åŠ¡
async def execute_with_dynamic_adjustment(tasks):
    results = {}
    
    for task in tasks:
        result = await execute_task(task)
        results[task.task_id] = result
        
        # æ ¹æ®ç»“æœåŠ¨æ€è°ƒæ•´åç»­ä»»åŠ¡
        if task.task_id == "check_condition":
            if result["condition"] == "A":
                # æ·»åŠ åˆ†æ”¯Açš„ä»»åŠ¡
                tasks.extend(get_branch_a_tasks())
            else:
                # æ·»åŠ åˆ†æ”¯Bçš„ä»»åŠ¡
                tasks.extend(get_branch_b_tasks())
    
    return results
```

**æ³¨æ„**ï¼šå¢åŠ å®ç°å¤æ‚åº¦ï¼Œéœ€æƒè¡¡æ”¶ç›Šã€‚

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- **æ¡†æ¶æ€»è§ˆ**: [../theory/æ¡†æ¶æ€»è§ˆ.md](../theory/æ¡†æ¶æ€»è§ˆ.md)
- **English Version**: [mcp-orchestration-architecture-en.md](./mcp-orchestration-architecture-en.md)ï¼ˆå¾…åˆ›å»ºï¼‰

---

## ğŸ“– å‚è€ƒæ–‡çŒ®

1. **Kahn's Algorithm**: Kahn, A. B. (1962). "Topological sorting of large networks"
2. **Apache Airflow**: Airbnb Engineering (2014). "Airflow: a workflow management platform"
3. **asyncio**: Python Software Foundation. "asyncio â€” Asynchronous I/O"

---

**ç»´æŠ¤è€…**: DAML-RAG Framework Team  
**æœ€åå®¡æŸ¥**: 2025-11-06

<div align="center">
<strong>ğŸ¯ é€šç”¨æ¶æ„ Â· ğŸš€ é¢†åŸŸæ— å…³ Â· ğŸ“Š æ€§èƒ½ä¼˜åŒ–</strong>
</div>

