# Thompson Samplingå·¥å…·å­¦ä¹  - ç†è®ºç»„ä»¶è¯´æ˜

**çŠ¶æ€**: âš ï¸ ç†è®ºæ¢ç´¢ / æœªæ¥æ‰©å±•  
**æ¥æº**: BUILD_BODYé¡¹ç›®å®è·µç»éªŒ  
**æ—¥æœŸ**: 2025-11-07

---

## ğŸ“Œ æ¦‚è¿°

æœ¬ç›®å½•åŒ…å«åŸºäº **Thompson Sampling + Contextual Bandit** çš„å·¥å…·é€‰æ‹©å­¦ä¹ ç®—æ³•ï¼Œè¿™æ˜¯ä»BUILD_BODYé¡¹ç›®ä¸­æå–çš„ç†è®ºç»„ä»¶ã€‚

**ä¸ºä»€ä¹ˆæ ‡è®°ä¸º"ç†è®ºç»„ä»¶"ï¼Ÿ**

åœ¨BUILD_BODYå®é™…åº”ç”¨ä¸­å‘ç°ï¼Œæ­¤ç®—æ³•åœ¨å½“å‰åœºæ™¯ä¸‹æ˜¯**è¿‡åº¦è®¾è®¡**ï¼š

### âŒ ä¸é€‚ç”¨åœºæ™¯ï¼ˆç‰çå®è·µï¼‰

1. **åªæœ‰1ä¸ªMCPæœåŠ¡å™¨**
   - Thompson Samplingè®¾è®¡ç”¨äº**å¤šä¸ªé€‰é¡¹**ä¹‹é—´çš„é€‰æ‹©
   - BUILD_BODYåªæœ‰1ä¸ªfitness MCP â†’ æ— éœ€é€‰æ‹©

2. **å·¥å…·é€‰æ‹©å·²è¢«DAGæ›¿ä»£**
   - ç°ä½¿ç”¨ **Kahnæ‹“æ‰‘æ’åº + DAGç¼–æ’**
   - åŸºäºä¾èµ–å…³ç³»ç¡®å®šæ€§æ‰§è¡Œï¼Œä¸éœ€è¦æ¦‚ç‡é€‰æ‹©

3. **ç”¨æˆ·æ ·æœ¬ä¸è¶³**
   - Thompson Samplingéœ€è¦ **>1000æ¬¡äº¤äº’**æ‰èƒ½æœ‰æ•ˆå­¦ä¹ 
   - ç‰çæ—©æœŸé˜¶æ®µæ ·æœ¬é‡ä¸è¶³

---

## âœ… é€‚ç”¨åœºæ™¯ï¼ˆç†è®ºä¸Šï¼‰

æ­¤ç®—æ³•åœ¨ä»¥ä¸‹åœºæ™¯ä¸‹**ä»æœ‰ä»·å€¼**ï¼š

### åœºæ™¯1ï¼šå¤šMCPæœåŠ¡å™¨ç«äº‰

```
ç”¨æˆ·æŸ¥è¯¢: "å¦‚ä½•å¢è‚Œï¼Ÿ"

å¯é€‰MCPæœåŠ¡å™¨ï¼š
â”œâ”€â”€ fitness_mcp_a (å‡†ç¡®ç‡85%)
â”œâ”€â”€ fitness_mcp_b (å‡†ç¡®ç‡90%)
â””â”€â”€ fitness_mcp_c (å‡†ç¡®ç‡80%)

Thompson Samplingè‡ªåŠ¨å­¦ä¹ ï¼š
â†’ é€æ¸å€¾å‘é€‰æ‹© mcp_b
â†’ åŒæ—¶ä¿æŒä¸€å®šæ¢ç´¢ç‡ï¼ˆÎµ-greedyï¼‰
```

### åœºæ™¯2ï¼šå·¥å…·é“¾A/Bæµ‹è¯•

```
åŒä¸€åŠŸèƒ½çš„ä¸¤ç§å®ç°ï¼š

å·¥å…·é“¾A: get_profile â†’ design_plan_v1 â†’ recommend_exercises
å·¥å…·é“¾B: get_profile â†’ design_plan_v2 â†’ recommend_exercises_advanced

Thompson Samplingè‡ªåŠ¨å­¦ä¹ ï¼š
â†’ æ ¹æ®ç”¨æˆ·åé¦ˆè¯„åˆ†ï¼ˆ1-5åˆ†ï¼‰
â†’ è‡ªåŠ¨æ”¶æ•›åˆ°æ•ˆæœæ›´å¥½çš„å·¥å…·é“¾
```

### åœºæ™¯3ï¼šä¸ªæ€§åŒ–å·¥å…·æ¨è

```
ä¸åŒç”¨æˆ·åå¥½ä¸åŒçš„å·¥å…·ç»„åˆï¼š

æ–°æ‰‹ç”¨æˆ·: å€¾å‘ç®€å•å·¥å…·é“¾
é«˜çº§ç”¨æˆ·: å€¾å‘å¤æ‚å·¥å…·é“¾

Contextual Banditï¼ˆè€ƒè™‘ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼‰ï¼š
â†’ æ ¹æ®ç”¨æˆ·å‘é‡ç›¸ä¼¼åº¦
â†’ æ¨èé€‚åˆè¯¥ç”¨æˆ·çš„å·¥å…·é“¾
```

---

## ğŸ”¬ ç†è®ºåŸºç¡€

### 1. Thompson Sampling

**æ ¸å¿ƒæ€æƒ³**ï¼šè´å¶æ–¯MABç®—æ³•ï¼Œç”¨Betaåˆ†å¸ƒå»ºæ¨¡ä¸ç¡®å®šæ€§

```python
# ä¼ªä»£ç 
for each toolchain:
    # ä»Betaåˆ†å¸ƒé‡‡æ ·
    sampled_reward = beta_distribution(alpha, beta)
    
# é€‰æ‹©é‡‡æ ·å€¼æœ€é«˜çš„å·¥å…·é“¾
selected_toolchain = argmax(sampled_rewards)
```

**ä¼˜åŠ¿**ï¼š
- âœ… è‡ªé€‚åº”æ¢ç´¢ï¼šä¸ç¡®å®šæ€§å¤§çš„é€‰é¡¹æ›´å®¹æ˜“è¢«é‡‡æ ·
- âœ… ç†è®ºä¿è¯ï¼šæ¸è¿›æœ€ä¼˜ï¼ˆæ”¶æ•›åˆ°æœ€ä½³é€‰é¡¹ï¼‰
- âœ… å‚æ•°è‡ªåŠ¨æ›´æ–°ï¼šæ— éœ€æ‰‹åŠ¨è°ƒå‚

### 2. Contextual Bandit

**æ‰©å±•**ï¼šè€ƒè™‘ä¸Šä¸‹æ–‡ï¼ˆæŸ¥è¯¢å‘é‡ï¼‰

```python
# æ£€ç´¢ç›¸ä¼¼å†å²æ¡ˆä¾‹
similar_cases = retrieve_similar(query_vector, threshold=0.7)

# åŸºäºç›¸ä¼¼æ¡ˆä¾‹çš„ç»Ÿè®¡
for case in similar_cases:
    toolchain_stats[case.toolchain] += case.reward
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä¸ªæ€§åŒ–ï¼šä¸åŒæŸ¥è¯¢æ¨èä¸åŒå·¥å…·é“¾
- âœ… è¿ç§»å­¦ä¹ ï¼šç›¸ä¼¼æŸ¥è¯¢å…±äº«ç»éªŒ

### 3. Îµ-Greedyæ¢ç´¢

**åŠ¨æ€æ¢ç´¢ç‡**ï¼š

```python
epsilon = base_epsilon * exp(-decay_rate * total_samples)

# æ¢ç´¢ç‡éšæ ·æœ¬é‡æŒ‡æ•°è¡°å‡
# åˆæœŸï¼šå¤§é‡æ¢ç´¢ï¼ˆå¦‚0.3ï¼‰
# åæœŸï¼šä¸»è¦åˆ©ç”¨ï¼ˆå¦‚0.01ï¼‰
```

---

## ğŸ“Š BUILD_BODYå®è·µæ•°æ®

### å®éªŒ1ï¼šå·¥å…·é“¾æ¨èï¼ˆ2025-10ï¼‰

**è®¾ç½®**ï¼š
- ç”¨æˆ·æ•°ï¼š50
- äº¤äº’æ¬¡æ•°ï¼š200
- å·¥å…·é“¾æ•°ï¼š5

**ç»“æœ**ï¼š
```
æ ·æœ¬é‡ä¸è¶³ï¼Œæ— æ³•æœ‰æ•ˆå­¦ä¹ 
- æ”¶æ•›é€Ÿåº¦æ…¢ï¼ˆéœ€>1000æ¬¡ï¼‰
- ç½®ä¿¡åº¦ä½ï¼ˆ<0.6ï¼‰
- ä¸å¦‚ç¡®å®šæ€§DAGç¨³å®š
```

**ç»“è®º**ï¼šâŒ æ ·æœ¬é‡ä¸è¶³ï¼Œæš‚ä¸å¯ç”¨

---

### å®éªŒ2ï¼šDAG vs Thompson Samplingå¯¹æ¯”

| æŒ‡æ ‡ | DAGç¼–æ’ | Thompson Sampling |
|-----|--------|------------------|
| **ç¡®å®šæ€§** | âœ… 100% | âŒ æ¦‚ç‡æ€§ |
| **ä¾èµ–å¤„ç†** | âœ… Kahnæ‹“æ‰‘ | âŒ éœ€äººå·¥å®šä¹‰ |
| **æ ·æœ¬éœ€æ±‚** | âœ… 0æ ·æœ¬ | âŒ >1000æ ·æœ¬ |
| **é€‚åº”æ€§** | âŒ å›ºå®š | âœ… è‡ªé€‚åº” |
| **å¯è§£é‡Šæ€§** | âœ… æ¸…æ™° | âš ï¸ æ¦‚ç‡ |

**ç»“è®º**ï¼šBUILD_BODYå½“å‰é˜¶æ®µï¼Œ**DAGæ›´åˆé€‚**

---

## ğŸ”® æœªæ¥æ½œåŠ›

### ä½•æ—¶å¯ç”¨Thompson Samplingï¼Ÿ

æ»¡è¶³ä»¥ä¸‹**ä»»æ„2ä¸ªæ¡ä»¶**ï¼š

1. âœ… **å¤šMCPæœåŠ¡å™¨**ï¼ˆâ‰¥2ä¸ªæä¾›ç±»ä¼¼åŠŸèƒ½çš„MCPï¼‰
2. âœ… **å¤§é‡ç”¨æˆ·æ ·æœ¬**ï¼ˆ>1000æ¬¡äº¤äº’ï¼‰
3. âœ… **éœ€è¦è‡ªé€‚åº”**ï¼ˆå·¥å…·æ•ˆæœä¼šéšæ—¶é—´å˜åŒ–ï¼‰
4. âœ… **A/Bæµ‹è¯•éœ€æ±‚**ï¼ˆéœ€è¦å¯¹æ¯”ä¸åŒå·¥å…·é“¾ï¼‰

### é›†æˆå»ºè®®

```python
from daml_rag.learning.tool_learner_thompson import ToolLearnerThompson

# æ£€æŸ¥æ˜¯å¦æ»¡è¶³å¯ç”¨æ¡ä»¶
if config.mcp_servers_count >= 2 and total_interactions > 1000:
    # å¯ç”¨Thompson Sampling
    tool_learner = ToolLearnerThompson(
        epsilon=0.05,  # ä½æ¢ç´¢ç‡ï¼ˆå·²æœ‰è¶³å¤Ÿæ•°æ®ï¼‰
        min_trials=10,
        dynamic_epsilon=True
    )
    
    # æ¨èå·¥å…·é“¾
    recommendation = tool_learner.recommend_toolchain(
        user_id=user_id,
        query_vector=query_vector,
        top_k=3
    )
else:
    # ä½¿ç”¨ç¡®å®šæ€§DAGç¼–æ’
    orchestrator.execute_workflow(...)
```

---

## ğŸ“š è®ºæ–‡å‚è€ƒ

1. **Thompson Sampling for Contextual Bandits**  
   Agrawal & Goyal, 2013  
   https://arxiv.org/abs/1209.3352

2. **A Survey on Contextual Multi-armed Bandits**  
   Zhou, 2015  
   https://arxiv.org/abs/1508.03326

3. **Analysis of Thompson Sampling**  
   Kaufmann et al., 2012  
   https://papers.nips.cc/paper/4321-analysis-of-thompson-sampling

---

## ğŸ› ï¸ å®ç°æ–‡ä»¶

- `tool_learner_thompson.py` - Thompson Samplingå®ç°ï¼ˆç†è®ºç»„ä»¶ï¼‰
- `mcp_learning_tracker.py` - å­¦ä¹ è¿›åº¦è¿½è¸ªï¼ˆBUILD_BODYæå–ï¼‰

---

## âš ï¸ é‡è¦æé†’

1. **ä¸è¦ç›²ç›®å¯ç”¨**ï¼šç¡®è®¤åœºæ™¯é€‚ç”¨åå†é›†æˆ
2. **éœ€è¦å¤§é‡æ ·æœ¬**ï¼š<1000æ¬¡äº¤äº’æ•ˆæœä¸ä½³
3. **DAGä¼˜å…ˆ**ï¼šç¡®å®šæ€§ç¼–æ’é€šå¸¸æ›´ç¨³å®š
4. **ç›‘æ§æŒ‡æ ‡**ï¼šæ”¶æ•›é€Ÿåº¦ã€ç½®ä¿¡åº¦ã€ç”¨æˆ·æ»¡æ„åº¦

---

**ç»´æŠ¤è€…**: DAML-RAG Framework Team  
**æ¥æº**: BUILD_BODY Project (2025-11-07)  
**çŠ¶æ€**: ç†è®ºå­˜æ¡£ / æœªæ¥æ‰©å±•

<div align="center">
<strong>ğŸ”¬ ç†è®ºæ¢ç´¢ Â· ğŸ¯ åœºæ™¯é€‚é… Â· ğŸš€ æœªæ¥æ½œåŠ›</strong>
</div>















